<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vutils - Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #58a6ff; margin-bottom: 0.5rem; }
        h2 { color: #c9d1d9; margin: 2.5rem 0 1rem; font-size: 1.4rem; border-bottom: 1px solid #30363d; padding-bottom: 0.5rem; }
        h3 { color: #8b949e; margin: 1.5rem 0 1rem; font-size: 1rem; }
        .subtitle { color: #8b949e; margin-bottom: 2rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1.5rem;
        }
        .card h4 { color: #58a6ff; margin-bottom: 1rem; font-size: 0.95rem; }
        .stat { font-size: 2.2rem; font-weight: bold; color: #7ee787; }
        .stat.warn { color: #f0883e; }
        .stat-label { color: #8b949e; font-size: 0.875rem; }
        .chart-container { position: relative; height: 250px; }
        table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        th, td { text-align: left; padding: 0.4rem 0.6rem; border-bottom: 1px solid #30363d; }
        th { color: #8b949e; font-weight: 500; font-size: 0.8rem; }
        td { font-size: 0.85rem; }
        .mono { font-family: monospace; }
        a { color: #58a6ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .updated { color: #8b949e; font-size: 0.8rem; margin-top: 2rem; }
        .platform-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        .platform-linux { background: #238636; color: white; }
        .platform-darwin { background: #1f6feb; color: white; }
        .binary-section { margin-bottom: 2rem; }
        .no-data { color: #8b949e; font-style: italic; padding: 2rem; text-align: center; }
    </style>
</head>
<body>
    <h1>vutils</h1>
    <p class="subtitle">Fast, platform-optimized coreutils in Zig</p>

    <div class="grid">
        <div class="card">
            <h4>GNU Test Conformance</h4>
            <div class="stat" id="conformance">--%</div>
            <div class="stat-label">wc tests passing</div>
        </div>
        <div class="card">
            <h4>wc vs GNU (Linux)</h4>
            <div class="stat" id="speedup-wc-linux">--x</div>
            <div class="stat-label">faster</div>
        </div>
        <div class="card">
            <h4>wc vs BSD (macOS)</h4>
            <div class="stat" id="speedup-wc-macos">--x</div>
            <div class="stat-label">faster</div>
        </div>
        <div class="card">
            <h4>Binary Size</h4>
            <div class="stat" id="size">-- KB</div>
            <div class="stat-label">ReleaseSmall</div>
        </div>
    </div>

    <!-- wc section -->
    <h2>wc - word count</h2>
    <div class="grid-2">
        <div class="card">
            <h4><span class="platform-badge platform-linux">Linux</span> Performance History</h4>
            <div class="chart-container">
                <canvas id="wc-chart-linux"></canvas>
            </div>
        </div>
        <div class="card">
            <h4><span class="platform-badge platform-darwin">macOS</span> Performance History</h4>
            <div class="chart-container">
                <canvas id="wc-chart-macos"></canvas>
            </div>
        </div>
    </div>
    <h3>Latest Results</h3>
    <div class="grid-2">
        <div class="card">
            <h4><span class="platform-badge platform-linux">Linux</span> 50 files, 50MB</h4>
            <table><tbody id="wc-table-linux"><tr><td>Loading...</td></tr></tbody></table>
        </div>
        <div class="card">
            <h4><span class="platform-badge platform-darwin">macOS</span> 50 files, 50MB</h4>
            <table><tbody id="wc-table-macos"><tr><td>Loading...</td></tr></tbody></table>
        </div>
    </div>

    <!-- echo section -->
    <h2>echo</h2>
    <div class="grid-2">
        <div class="card">
            <h4><span class="platform-badge platform-linux">Linux</span> Performance History</h4>
            <div class="chart-container">
                <canvas id="echo-chart-linux"></canvas>
            </div>
        </div>
        <div class="card">
            <h4><span class="platform-badge platform-darwin">macOS</span> Performance History</h4>
            <div class="chart-container">
                <canvas id="echo-chart-macos"></canvas>
            </div>
        </div>
    </div>
    <h3>Latest Results</h3>
    <div class="grid-2">
        <div class="card">
            <h4><span class="platform-badge platform-linux">Linux</span> ms per call</h4>
            <table><tbody id="echo-table-linux"><tr><td>Loading...</td></tr></tbody></table>
        </div>
        <div class="card">
            <h4><span class="platform-badge platform-darwin">macOS</span> ms per call</h4>
            <table><tbody id="echo-table-macos"><tr><td>Loading...</td></tr></tbody></table>
        </div>
    </div>

    <!-- Conformance section -->
    <h2>GNU Test Suite Conformance</h2>
    <div class="card">
        <div class="chart-container">
            <canvas id="conformanceChart"></canvas>
        </div>
    </div>

    <p class="updated" id="updated"></p>

    <script>
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
                x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxRotation: 45 } },
                y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' }, beginAtZero: true }
            },
            plugins: { legend: { labels: { color: '#c9d1d9', boxWidth: 12, padding: 8 }, position: 'bottom' } }
        };

        function renderTable(tableId, data, type) {
            const table = document.getElementById(tableId);
            if (!data) {
                table.innerHTML = '<tr><td class="no-data">No data yet</td></tr>';
                return;
            }
            const r = data.results;
            let html = '';
            
            if (type === 'wc') {
                html = `<tr><td>vutils</td><td class="mono">${r.vutils_ms} ms</td><td>baseline</td></tr>`;
                if (r.gnu_ms) html += `<tr><td>GNU</td><td class="mono">${r.gnu_ms} ms</td><td>${r.speedup_vs_gnu}x</td></tr>`;
                if (r.bsd_ms) html += `<tr><td>BSD</td><td class="mono">${r.bsd_ms} ms</td><td>${r.speedup_vs_bsd}x</td></tr>`;
                if (r.uutils_ms) html += `<tr><td>uutils</td><td class="mono">${r.uutils_ms} ms</td><td>${r.speedup_vs_uutils}x</td></tr>`;
                if (r.busybox_ms) html += `<tr><td>busybox</td><td class="mono">${r.busybox_ms} ms</td><td>${r.speedup_vs_busybox}x</td></tr>`;
            } else if (type === 'echo') {
                html = `<tr><td>vutils</td><td class="mono">${r.vutils_simple_ms} ms</td><td>baseline</td></tr>`;
                if (r.gnu_simple_ms) html += `<tr><td>GNU</td><td class="mono">${r.gnu_simple_ms} ms</td><td>${r.speedup_vs_gnu}x</td></tr>`;
                if (r.bsd_simple_ms) html += `<tr><td>BSD</td><td class="mono">${r.bsd_simple_ms} ms</td><td>${r.speedup_vs_bsd}x</td></tr>`;
            }
            
            table.innerHTML = html || '<tr><td class="no-data">No data</td></tr>';
        }

        function createChart(canvasId, data, platform, type) {
            if (!data || data.length === 0) {
                document.getElementById(canvasId).parentElement.innerHTML = '<div class="no-data">No data yet</div>';
                return;
            }
            
            const labels = data.map(d => d.git_commit);
            const datasets = [];
            
            if (type === 'wc') {
                datasets.push({ label: 'vutils', data: data.map(d => d.results?.vutils_ms), borderColor: '#7ee787', tension: 0.3 });
                if (platform === 'linux') {
                    datasets.push({ label: 'GNU', data: data.map(d => d.results?.gnu_ms), borderColor: '#f0883e', tension: 0.3 });
                    datasets.push({ label: 'uutils', data: data.map(d => d.results?.uutils_ms), borderColor: '#a371f7', tension: 0.3 });
                } else {
                    datasets.push({ label: 'BSD', data: data.map(d => d.results?.bsd_ms), borderColor: '#58a6ff', tension: 0.3 });
                    datasets.push({ label: 'GNU', data: data.map(d => d.results?.gnu_ms), borderColor: '#f0883e', tension: 0.3 });
                }
            } else if (type === 'echo') {
                datasets.push({ label: 'vutils', data: data.map(d => d.results?.vutils_simple_ms), borderColor: '#7ee787', tension: 0.3 });
                if (platform === 'linux') {
                    datasets.push({ label: 'GNU', data: data.map(d => d.results?.gnu_simple_ms), borderColor: '#f0883e', tension: 0.3 });
                } else {
                    datasets.push({ label: 'BSD', data: data.map(d => d.results?.bsd_simple_ms), borderColor: '#58a6ff', tension: 0.3 });
                    datasets.push({ label: 'GNU', data: data.map(d => d.results?.gnu_simple_ms), borderColor: '#f0883e', tension: 0.3 });
                }
            }
            
            new Chart(document.getElementById(canvasId), { type: 'line', data: { labels, datasets }, options: chartOptions });
        }

        async function loadData() {
            // Load conformance
            try {
                const confRes = await fetch('data/conformance.json');
                const confData = await confRes.json();
                if (confData.length > 0) {
                    const latest = confData[confData.length - 1];
                    document.getElementById('conformance').textContent = latest.conformance_pct + '%';
                    new Chart(document.getElementById('conformanceChart'), {
                        type: 'line',
                        data: {
                            labels: confData.map(d => d.git_commit || d.timestamp?.slice(0, 10)),
                            datasets: [{ label: 'Pass Rate %', data: confData.map(d => d.conformance_pct), borderColor: '#7ee787', backgroundColor: 'rgba(126,231,135,0.1)', fill: true, tension: 0.3 }]
                        },
                        options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } }
                    });
                }
            } catch (e) { console.log('No conformance data'); }

            // Load benchmarks
            try {
                const benchRes = await fetch('data/benchmarks.json');
                const benchData = await benchRes.json();
                
                // wc
                const wcLinux = benchData.filter(d => d.binary === 'wc' && d.platform === 'linux');
                const wcMacos = benchData.filter(d => d.binary === 'wc' && d.platform === 'darwin');
                createChart('wc-chart-linux', wcLinux, 'linux', 'wc');
                createChart('wc-chart-macos', wcMacos, 'darwin', 'wc');
                renderTable('wc-table-linux', wcLinux[wcLinux.length - 1], 'wc');
                renderTable('wc-table-macos', wcMacos[wcMacos.length - 1], 'wc');
                
                // Update summary stats
                if (wcLinux.length) document.getElementById('speedup-wc-linux').textContent = (wcLinux[wcLinux.length-1].results?.speedup_vs_gnu || '--') + 'x';
                if (wcMacos.length) document.getElementById('speedup-wc-macos').textContent = (wcMacos[wcMacos.length-1].results?.speedup_vs_bsd || '--') + 'x';
                
                // echo
                const echoLinux = benchData.filter(d => d.binary === 'echo' && d.platform === 'linux');
                const echoMacos = benchData.filter(d => d.binary === 'echo' && d.platform === 'darwin');
                createChart('echo-chart-linux', echoLinux, 'linux', 'echo');
                createChart('echo-chart-macos', echoMacos, 'darwin', 'echo');
                renderTable('echo-table-linux', echoLinux[echoLinux.length - 1], 'echo');
                renderTable('echo-table-macos', echoMacos[echoMacos.length - 1], 'echo');
                
                document.getElementById('size').textContent = '93 KB';
                
                const latest = benchData[benchData.length - 1];
                if (latest) document.getElementById('updated').textContent = 'Last updated: ' + latest.timestamp;
            } catch (e) { console.error('Error loading benchmarks:', e); }
        }

        loadData();
    </script>
</body>
</html>
