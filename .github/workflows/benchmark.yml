name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  benchmark:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
          - os: ubuntu-latest
            platform: linux

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v1
        with:
          version: 0.14.0

      - name: Install dependencies (macOS)
        if: matrix.platform == 'darwin'
        run: |
          brew install jq coreutils
          # uutils conflicts with coreutils, install with --force
          brew install --force uutils-coreutils || true

      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq busybox

      - name: Run speed benchmark
        run: ./bench/benchmark.sh wc

      - name: Run size benchmark
        run: ./bench/benchmark.sh size

      - name: Save benchmark results
        if: github.ref == 'refs/heads/main'
        run: |
          ./bench/benchmark.sh wc --save
          
      - name: Upload benchmark data
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-${{ matrix.platform }}
          path: bench/data/*.jsonl
          retention-days: 90

  # Aggregate and commit benchmark data
  collect-benchmarks:
    needs: benchmark
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          path: bench/data/
          merge-multiple: true

      - name: Commit benchmark data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bench/data/*.jsonl
          git diff --staged --quiet || git commit -m "bench: update benchmark data [skip ci]"
          git push
