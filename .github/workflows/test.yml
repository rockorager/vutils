name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
          - os: ubuntu-latest
            platform: linux

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install dependencies (macOS)
        if: matrix.platform == 'darwin'
        run: |
          brew install coreutils
          brew install --quiet uutils-coreutils 2>/dev/null || true

      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y busybox locales
          sudo locale-gen en_US.UTF-8

      - name: Build (Debug)
        run: zig build

      - name: Unit tests
        run: zig build test

      - name: Integration tests
        run: zig build integration

      - name: Build (ReleaseSmall for comparisons)
        run: zig build -Doptimize=ReleaseSmall

      - name: Compare to BSD (macOS)
        if: matrix.platform == 'darwin'
        run: ./tests/compare_to_bsd.sh

      - name: Compare to GNU (UTF-8 locale)
        run: ./tests/compare_to_gnu.sh

      - name: Compare to GNU (C locale)
        run: LC_ALL=C ./tests/compare_to_gnu.sh

      - name: POSIX conformance tests (UTF-8)
        run: ./tests/posix/wc_test.sh

      - name: POSIX conformance tests (C locale)
        run: LC_ALL=C ./tests/posix/wc_test.sh

  # GNU test suite disabled for now - build infrastructure is flaky
  # gnu-test-suite:
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Zig
  #       uses: mlugg/setup-zig@v2
  #       with:
  #         version: 0.15.2
  #     - name: Build vutils
  #       run: zig build -Doptimize=ReleaseSmall
  #     - name: Run GNU test suite (wc)
  #       run: ./tests/gnu/run-gnu-tests.sh --wc
