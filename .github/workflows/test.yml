name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
          - os: ubuntu-latest
            platform: linux

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install dependencies (macOS)
        if: matrix.platform == 'darwin'
        run: |
          brew install coreutils
          brew install --quiet uutils-coreutils 2>/dev/null || true

      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y busybox locales
          sudo locale-gen en_US.UTF-8

      - name: Build (Debug)
        run: zig build

      - name: Unit tests
        run: zig build test

      - name: Integration tests
        run: zig build integration

      - name: Build (ReleaseSmall for comparisons)
        run: zig build -Doptimize=ReleaseSmall

      - name: Compare to BSD (macOS)
        if: matrix.platform == 'darwin'
        run: ./tests/compare_to_bsd.sh

      - name: Compare to GNU (UTF-8 locale)
        run: ./tests/compare_to_gnu.sh

      - name: Compare to GNU (C locale)
        run: LC_ALL=C ./tests/compare_to_gnu.sh

      - name: POSIX conformance tests (UTF-8)
        run: ./tests/posix/wc_test.sh

      - name: POSIX conformance tests (C locale)
        run: LC_ALL=C ./tests/posix/wc_test.sh

  gnu-test-suite:
    runs-on: ubuntu-24.04
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install GNU test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf autopoint texinfo gperf \
            gettext bison perl python3
          # Install automake 1.18+ for C23 stdckdint.h support
          curl -sL http://launchpadlibrarian.net/831710181/automake_1.18.1-3_all.deb -o automake-1.18.deb
          sudo dpkg -i --force-depends automake-1.18.deb

      - name: Build vutils
        run: zig build -Doptimize=ReleaseSmall

      - name: Run GNU test suite (wc)
        run: ./tests/gnu/run-gnu-tests.sh --wc

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gnu-test-results
          path: |
            tests/gnu/conformance.json
            tests/gnu/test-results.log
